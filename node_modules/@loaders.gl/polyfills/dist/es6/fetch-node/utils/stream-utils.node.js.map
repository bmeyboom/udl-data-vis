{"version":3,"sources":["../../../../src/fetch-node/utils/stream-utils.node.js"],"names":["fs","http","https","zlib","toArrayBuffer","isRequestURL","url","startsWith","createReadStream","options","noqueryUrl","split","Promise","resolve","reject","stream","encoding","once","on","error","requestFunction","request","requestOptions","getRequestOptions","req","res","end","decompressReadStream","readStream","headers","get","pipe","createBrotliDecompress","createGunzip","createDeflate","concatenateReadStream","arrayBuffer","ArrayBuffer","read","chunk","Error","chunkAsArrayBuffer","concatenateArrayBuffers","originalHeaders","key","Object","keys","toLowerCase","urlObject","URL","hostname","path","pathname","method","fetch","source1","source2","sourceArray1","Uint8Array","sourceArray2","temp","byteLength","set","buffer"],"mappings":"AACA,OAAOA,EAAP,MAAe,IAAf;AACA,OAAOC,IAAP,MAAiB,MAAjB;AACA,OAAOC,KAAP,MAAkB,OAAlB;AACA,OAAOC,IAAP,MAAiB,MAAjB;AAEA,SAAQC,aAAR,QAA4B,wBAA5B;;AAEA,MAAMC,YAAY,GAAGC,GAAG,IAAIA,GAAG,CAACC,UAAJ,CAAe,OAAf,KAA2BD,GAAG,CAACC,UAAJ,CAAe,QAAf,CAAvD;;AAGA,OAAO,eAAeC,gBAAf,CAAgCF,GAAhC,EAAqCG,OAArC,EAA8C;AAEnD,MAAI,CAACJ,YAAY,CAACC,GAAD,CAAjB,EAAwB;AACtB,UAAMI,UAAU,GAAGJ,GAAG,CAACK,KAAJ,CAAU,GAAV,EAAe,CAAf,CAAnB;AAEA,WAAO,MAAM,IAAIC,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AAE5C,YAAMC,MAAM,GAAGf,EAAE,CAACQ,gBAAH,CAAoBE,UAApB,EAAgC;AAACM,QAAAA,QAAQ,EAAE;AAAX,OAAhC,CAAf;AACAD,MAAAA,MAAM,CAACE,IAAP,CAAY,UAAZ,EAAwB,MAAMJ,OAAO,CAACE,MAAD,CAArC;AACAA,MAAAA,MAAM,CAACG,EAAP,CAAU,OAAV,EAAmBC,KAAK,IAAIL,MAAM,CAACK,KAAD,CAAlC;AACD,KALY,CAAb;AAMD;;AAID,SAAO,MAAM,IAAIP,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AAC5C,UAAMM,eAAe,GAAGd,GAAG,CAACC,UAAJ,CAAe,QAAf,IAA2BL,KAAK,CAACmB,OAAjC,GAA2CpB,IAAI,CAACoB,OAAxE;AACA,UAAMC,cAAc,GAAGC,iBAAiB,CAACjB,GAAD,EAAMG,OAAN,CAAxC;AACA,UAAMe,GAAG,GAAGJ,eAAe,CAACE,cAAD,EAAiBG,GAAG,IAAIZ,OAAO,CAACY,GAAD,CAA/B,CAA3B;AACAD,IAAAA,GAAG,CAACN,EAAJ,CAAO,OAAP,EAAgBC,KAAK,IAAIL,MAAM,CAACK,KAAD,CAA/B;AACAK,IAAAA,GAAG,CAACE,GAAJ;AACD,GANY,CAAb;AAOD;AAED,OAAO,SAASC,oBAAT,CAA8BC,UAA9B,EAA0CC,OAA1C,EAAmD;AACxD,UAAQA,OAAO,CAACC,GAAR,CAAY,kBAAZ,CAAR;AACE,SAAK,IAAL;AACE,aAAOF,UAAU,CAACG,IAAX,CAAgB5B,IAAI,CAAC6B,sBAAL,EAAhB,CAAP;;AACF,SAAK,MAAL;AACE,aAAOJ,UAAU,CAACG,IAAX,CAAgB5B,IAAI,CAAC8B,YAAL,EAAhB,CAAP;;AACF,SAAK,SAAL;AACE,aAAOL,UAAU,CAACG,IAAX,CAAgB5B,IAAI,CAAC+B,aAAL,EAAhB,CAAP;;AACF;AAEE,aAAON,UAAP;AATJ;AAWD;AAED,OAAO,eAAeO,qBAAf,CAAqCP,UAArC,EAAiD;AACtD,MAAIQ,WAAW,GAAG,IAAIC,WAAJ,CAAgB,CAAhB,CAAlB;AAEA,SAAO,MAAM,IAAIzB,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AAC5Cc,IAAAA,UAAU,CAACV,EAAX,CAAc,OAAd,EAAuBC,KAAK,IAAIL,MAAM,CAACK,KAAD,CAAtC;AAIAS,IAAAA,UAAU,CAACV,EAAX,CAAc,UAAd,EAA0B,MAAMU,UAAU,CAACU,IAAX,EAAhC;AAEAV,IAAAA,UAAU,CAACV,EAAX,CAAc,MAAd,EAAsBqB,KAAK,IAAI;AAC7B,UAAI,OAAOA,KAAP,KAAiB,QAArB,EAA+B;AAC7BzB,QAAAA,MAAM,CAAC,IAAI0B,KAAJ,CAAU,wBAAV,CAAD,CAAN;AACD;;AACD,YAAMC,kBAAkB,GAAGrC,aAAa,CAACmC,KAAD,CAAxC;AACAH,MAAAA,WAAW,GAAGM,uBAAuB,CAACN,WAAD,EAAcK,kBAAd,CAArC;AACD,KAND;AAQAb,IAAAA,UAAU,CAACV,EAAX,CAAc,KAAd,EAAqB,MAAML,OAAO,CAACuB,WAAD,CAAlC;AACD,GAhBY,CAAb;AAiBD;;AAID,SAASb,iBAAT,CAA2BjB,GAA3B,EAAgCG,OAAO,GAAG,EAA1C,EAA8C;AAE5C,QAAMkC,eAAe,GAAGlC,OAAO,CAACoB,OAAR,IAAmB,EAA3C;AACA,QAAMA,OAAO,GAAG,EAAhB;;AACA,OAAK,MAAMe,GAAX,IAAkBC,MAAM,CAACC,IAAP,CAAYH,eAAZ,CAAlB,EAAgD;AAC9Cd,IAAAA,OAAO,CAACe,GAAG,CAACG,WAAJ,EAAD,CAAP,GAA6BJ,eAAe,CAACC,GAAD,CAA5C;AACD;;AAGDf,EAAAA,OAAO,CAAC,iBAAD,CAAP,GAA6BA,OAAO,CAAC,iBAAD,CAAP,IAA8B,iBAA3D;AAEA,QAAMmB,SAAS,GAAG,IAAIC,GAAJ,CAAQ3C,GAAR,CAAlB;AACA,SAAO;AACL4C,IAAAA,QAAQ,EAAEF,SAAS,CAACE,QADf;AAELC,IAAAA,IAAI,EAAEH,SAAS,CAACI,QAFX;AAGLC,IAAAA,MAAM,EAAE,KAHH;AAKL,OAAG5C,OALE;AAML,QAAIA,OAAO,CAAC6C,KAAR,IAAiB,EAArB,CANK;AAQLzB,IAAAA;AARK,GAAP;AAUD;;AAED,SAASa,uBAAT,CAAiCa,OAAjC,EAA0CC,OAA1C,EAAmD;AACjD,QAAMC,YAAY,GAAGF,OAAO,YAAYlB,WAAnB,GAAiC,IAAIqB,UAAJ,CAAeH,OAAf,CAAjC,GAA2DA,OAAhF;AACA,QAAMI,YAAY,GAAGH,OAAO,YAAYnB,WAAnB,GAAiC,IAAIqB,UAAJ,CAAeF,OAAf,CAAjC,GAA2DA,OAAhF;AACA,QAAMI,IAAI,GAAG,IAAIF,UAAJ,CAAeD,YAAY,CAACI,UAAb,GAA0BF,YAAY,CAACE,UAAtD,CAAb;AACAD,EAAAA,IAAI,CAACE,GAAL,CAASL,YAAT,EAAuB,CAAvB;AACAG,EAAAA,IAAI,CAACE,GAAL,CAASH,YAAT,EAAuBF,YAAY,CAACI,UAApC;AACA,SAAOD,IAAI,CAACG,MAAZ;AACD","sourcesContent":["/* global URL */\nimport fs from 'fs'; // `fs` will be empty object in browsers (see package.json \"browser\" field).\nimport http from 'http';\nimport https from 'https';\nimport zlib from 'zlib';\n\nimport {toArrayBuffer} from './decode-data-uri.node';\n\nconst isRequestURL = url => url.startsWith('http:') || url.startsWith('https:');\n\n// Returns a promise that resolves to a readable stream\nexport async function createReadStream(url, options) {\n  // Handle file streams in node\n  if (!isRequestURL(url)) {\n    const noqueryUrl = url.split('?')[0];\n    // Now open the stream\n    return await new Promise((resolve, reject) => {\n      // @ts-ignore\n      const stream = fs.createReadStream(noqueryUrl, {encoding: null});\n      stream.once('readable', () => resolve(stream));\n      stream.on('error', error => reject(error));\n    });\n  }\n\n  // HANDLE HTTP/HTTPS REQUESTS IN NODE\n  // TODO: THIS IS BAD SINCE WE RETURN A PROMISE INSTEAD OF A STREAM\n  return await new Promise((resolve, reject) => {\n    const requestFunction = url.startsWith('https:') ? https.request : http.request;\n    const requestOptions = getRequestOptions(url, options);\n    const req = requestFunction(requestOptions, res => resolve(res));\n    req.on('error', error => reject(error));\n    req.end();\n  });\n}\n\nexport function decompressReadStream(readStream, headers) {\n  switch (headers.get('content-encoding')) {\n    case 'br':\n      return readStream.pipe(zlib.createBrotliDecompress());\n    case 'gzip':\n      return readStream.pipe(zlib.createGunzip());\n    case 'deflate':\n      return readStream.pipe(zlib.createDeflate());\n    default:\n      // No compression or an unknown one, just return it as is\n      return readStream;\n  }\n}\n\nexport async function concatenateReadStream(readStream) {\n  let arrayBuffer = new ArrayBuffer(0);\n\n  return await new Promise((resolve, reject) => {\n    readStream.on('error', error => reject(error));\n\n    // Once the readable callback has been added, stream switches to \"flowing mode\"\n    // In Node 10 (but not 12 and 14) this causes `data` and `end` to never be called unless we read data here\n    readStream.on('readable', () => readStream.read());\n\n    readStream.on('data', chunk => {\n      if (typeof chunk === 'string') {\n        reject(new Error('Read stream not binary'));\n      }\n      const chunkAsArrayBuffer = toArrayBuffer(chunk);\n      arrayBuffer = concatenateArrayBuffers(arrayBuffer, chunkAsArrayBuffer);\n    });\n\n    readStream.on('end', () => resolve(arrayBuffer));\n  });\n}\n\n// HELPERS\n\nfunction getRequestOptions(url, options = {}) {\n  // Ensure header keys are lower case so that we can merge without duplicates\n  const originalHeaders = options.headers || {};\n  const headers = {};\n  for (const key of Object.keys(originalHeaders)) {\n    headers[key.toLowerCase()] = originalHeaders[key];\n  }\n\n  // Add default accept-encoding to headers\n  headers['accept-encoding'] = headers['accept-encoding'] || 'gzip,br,deflate';\n\n  const urlObject = new URL(url);\n  return {\n    hostname: urlObject.hostname,\n    path: urlObject.pathname,\n    method: 'GET',\n    // Add options and user provided 'options.fetch' overrides if available\n    ...options,\n    ...(options.fetch || {}),\n    // Override with updated headers with accepted encodings:\n    headers\n  };\n}\n\nfunction concatenateArrayBuffers(source1, source2) {\n  const sourceArray1 = source1 instanceof ArrayBuffer ? new Uint8Array(source1) : source1;\n  const sourceArray2 = source2 instanceof ArrayBuffer ? new Uint8Array(source2) : source2;\n  const temp = new Uint8Array(sourceArray1.byteLength + sourceArray2.byteLength);\n  temp.set(sourceArray1, 0);\n  temp.set(sourceArray2, sourceArray1.byteLength);\n  return temp.buffer;\n}\n"],"file":"stream-utils.node.js"}