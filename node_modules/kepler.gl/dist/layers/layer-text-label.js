"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getTextOffsetByRadius = getTextOffsetByRadius;
exports.formatTextLabelData = exports.textLabelAccessor = exports.defaultPadding = void 0;

var _viewportMercatorProject = require("viewport-mercator-project");

var _dataUtils = require("../utils/data-utils");

var _lodash = _interopRequireDefault(require("lodash.uniq"));

// Copyright (c) 2021 Uber Technologies, Inc.
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.
var defaultPadding = 20;
exports.defaultPadding = defaultPadding;

function getTextOffsetByRadius(radiusScale, getRadius, mapState) {
  return function (textLabel) {
    var distanceScale = (0, _viewportMercatorProject.getDistanceScales)(mapState);
    var xMult = textLabel.anchor === 'middle' ? 0 : textLabel.anchor === 'start' ? 1 : -1;
    var yMult = textLabel.alignment === 'center' ? 0 : textLabel.alignment === 'bottom' ? 1 : -1;
    var sizeOffset = textLabel.alignment === 'center' ? 0 : textLabel.alignment === 'bottom' ? textLabel.size : textLabel.size;
    var pixelRadius = radiusScale * distanceScale.pixelsPerMeter[0];
    var padding = defaultPadding;
    return typeof getRadius === 'function' ? function (d) {
      return [xMult * (getRadius(d) * pixelRadius + padding), yMult * (getRadius(d) * pixelRadius + padding + sizeOffset)];
    } : [xMult * (getRadius * pixelRadius + padding), yMult * (getRadius * pixelRadius + padding + sizeOffset)];
  };
}

var textLabelAccessor = function textLabelAccessor(textLabel) {
  return function (d) {
    var val = textLabel.field.valueAccessor(d.data);
    return (0, _dataUtils.notNullorUndefined)(val) ? String(val) : '';
  };
};

exports.textLabelAccessor = textLabelAccessor;

var formatTextLabelData = function formatTextLabelData(_ref) {
  var textLabel = _ref.textLabel,
      triggerChanged = _ref.triggerChanged,
      oldLayerData = _ref.oldLayerData,
      data = _ref.data;
  return textLabel.map(function (tl, i) {
    if (!tl.field) {
      // if no field selected,
      return {
        getText: null,
        characterSet: []
      };
    }

    var getText = textLabelAccessor(tl);
    var characterSet;

    if (!triggerChanged["getLabelCharacterSet-".concat(i)] && oldLayerData && oldLayerData.textLabels && oldLayerData.textLabels[i]) {
      characterSet = oldLayerData.textLabels[i].characterSet;
    } else {
      var allLabels = tl.field ? data.map(getText) : [];
      characterSet = (0, _lodash["default"])(allLabels.join(''));
    }

    return {
      characterSet: characterSet,
      getText: getText
    };
  });
};

exports.formatTextLabelData = formatTextLabelData;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYXllcnMvbGF5ZXItdGV4dC1sYWJlbC5qcyJdLCJuYW1lcyI6WyJkZWZhdWx0UGFkZGluZyIsImdldFRleHRPZmZzZXRCeVJhZGl1cyIsInJhZGl1c1NjYWxlIiwiZ2V0UmFkaXVzIiwibWFwU3RhdGUiLCJ0ZXh0TGFiZWwiLCJkaXN0YW5jZVNjYWxlIiwieE11bHQiLCJhbmNob3IiLCJ5TXVsdCIsImFsaWdubWVudCIsInNpemVPZmZzZXQiLCJzaXplIiwicGl4ZWxSYWRpdXMiLCJwaXhlbHNQZXJNZXRlciIsInBhZGRpbmciLCJkIiwidGV4dExhYmVsQWNjZXNzb3IiLCJ2YWwiLCJmaWVsZCIsInZhbHVlQWNjZXNzb3IiLCJkYXRhIiwiU3RyaW5nIiwiZm9ybWF0VGV4dExhYmVsRGF0YSIsInRyaWdnZXJDaGFuZ2VkIiwib2xkTGF5ZXJEYXRhIiwibWFwIiwidGwiLCJpIiwiZ2V0VGV4dCIsImNoYXJhY3RlclNldCIsInRleHRMYWJlbHMiLCJhbGxMYWJlbHMiLCJqb2luIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBb0JBOztBQUNBOztBQUNBOztBQXRCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQU1PLElBQU1BLGNBQWMsR0FBRyxFQUF2Qjs7O0FBRUEsU0FBU0MscUJBQVQsQ0FBK0JDLFdBQS9CLEVBQTRDQyxTQUE1QyxFQUF1REMsUUFBdkQsRUFBaUU7QUFDdEUsU0FBTyxVQUFBQyxTQUFTLEVBQUk7QUFDbEIsUUFBTUMsYUFBYSxHQUFHLGdEQUFrQkYsUUFBbEIsQ0FBdEI7QUFDQSxRQUFNRyxLQUFLLEdBQUdGLFNBQVMsQ0FBQ0csTUFBVixLQUFxQixRQUFyQixHQUFnQyxDQUFoQyxHQUFvQ0gsU0FBUyxDQUFDRyxNQUFWLEtBQXFCLE9BQXJCLEdBQStCLENBQS9CLEdBQW1DLENBQUMsQ0FBdEY7QUFD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UDtBQUlELEdBNUJNLENBQVA7QUE2QkQsQ0E5Qk0iLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIDIwMjEgVWJlciBUZWNobm9sb2dpZXMsIEluYy5cbi8vXG4vLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5XG4vLyBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSBcIlNvZnR3YXJlXCIpLCB0byBkZWFsXG4vLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzXG4vLyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsXG4vLyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXNcbi8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6XG4vL1xuLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW5cbi8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLlxuLy9cbi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1Jcbi8vIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuLy8gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXG4vLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXG4vLyBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuLy8gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTlxuLy8gVEhFIFNPRlRXQVJFLlxuXG5pbXBvcnQge2dldERpc3RhbmNlU2NhbGVzfSBmcm9tICd2aWV3cG9ydC1tZXJjYXRvci1wcm9qZWN0JztcbmltcG9ydCB7bm90TnVsbG9yVW5kZWZpbmVkfSBmcm9tICd1dGlscy9kYXRhLXV0aWxzJztcbmltcG9ydCB1bmlxIGZyb20gJ2xvZGFzaC51bmlxJztcblxuZXhwb3J0IGNvbnN0IGRlZmF1bHRQYWRkaW5nID0gMjA7XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRUZXh0T2Zmc2V0QnlSYWRpdXMocmFkaXVzU2NhbGUsIGdldFJhZGl1cywgbWFwU3RhdGUpIHtcbiAgcmV0dXJuIHRleHRMYWJlbCA9PiB7XG4gICAgY29uc3QgZGlzdGFuY2VTY2FsZSA9IGdldERpc3RhbmNlU2NhbGVzKG1hcFN0YXRlKTtcbiAgICBjb25zdCB4TXVsdCA9IHRleHRMYWJlbC5hbmNob3IgPT09ICdtaWRkbGUnID8gMCA6IHRleHRMYWJlbC5hbmNob3IgPT09ICdzdGFydCcgPyAxIDogLTE7XG4gICAgY29uc3QgeU11bHQgPSB0ZXh0TGFiZWwuYWxpZ25tZW50ID09PSAnY2VudGVyJyA/IDAgOiB0ZXh0TGFiZWwuYWxpZ25tZW50ID09PSAnYm90dG9tJyA/IDEgOiAtMTtcblxuICAgIGNvbnN0IHNpemVPZmZzZXQgPVxuICAgICAgdGV4dExhYmVsLmFsaWdubWVudCA9PT0gJ2NlbnRlcidcbiAgICAgICAgPyAwXG4gICAgICAgIDogdGV4dExhYmVsLmFsaWdubWVudCA9PT0gJ2JvdHRvbSdcbiAgICAgICAgPyB0ZXh0TGFiZWwuc2l6ZVxuICAgICAgICA6IHRleHRMYWJlbC5zaXplO1xuXG4gICAgY29uc3QgcGl4ZWxSYWRpdXMgPSByYWRpdXNTY2FsZSAqIGRpc3RhbmNlU2NhbGUucGl4ZWxzUGVyTWV0ZXJbMF07XG4gICAgY29uc3QgcGFkZGluZyA9IGRlZmF1bHRQYWRkaW5nO1xuXG4gICAgcmV0dXJuIHR5cGVvZiBnZXRSYWRpdXMgPT09ICdmdW5jdGlvbidcbiAgICAgID8gZCA9PiBbXG4gICAgICAgICAgeE11bHQgKiAoZ2V0UmFkaXVzKGQpICogcGl4ZWxSYWRpdXMgKyBwYWRkaW5nKSxcbiAgICAgICAgICB5TXVsdCAqIChnZXRSYWRpdXMoZCkgKiBwaXhlbFJhZGl1cyArIHBhZGRpbmcgKyBzaXplT2Zmc2V0KVxuICAgICAgICBdXG4gICAgICA6IFtcbiAgICAgICAgICB4TXVsdCAqIChnZXRSYWRpdXMgKiBwaXhlbFJhZGl1cyArIHBhZGRpbmcpLFxuICAgICAgICAgIHlNdWx0ICogKGdldFJhZGl1cyAqIHBpeGVsUmFkaXVzICsgcGFkZGluZyArIHNpemVPZmZzZXQpXG4gICAgICAgIF07XG4gIH07XG59XG5cbmV4cG9ydCBjb25zdCB0ZXh0TGFiZWxBY2Nlc3NvciA9IHRleHRMYWJlbCA9PiBkID0+IHtcbiAgY29uc3QgdmFsID0gdGV4dExhYmVsLmZpZWxkLnZhbHVlQWNjZXNzb3IoZC5kYXRhKTtcbiAgcmV0dXJuIG5vdE51bGxvclVuZGVmaW5lZCh2YWwpID8gU3RyaW5nKHZhbCkgOiAnJztcbn07XG5cbmV4cG9ydCBjb25zdCBmb3JtYXRUZXh0TGFiZWxEYXRhID0gKHt0ZXh0TGFiZWwsIHRyaWdnZXJDaGFuZ2VkLCBvbGRMYXllckRhdGEsIGRhdGF9KSA9PiB7XG4gIHJldHVybiB0ZXh0TGFiZWwubWFwKCh0bCwgaSkgPT4ge1xuICAgIGlmICghdGwuZmllbGQpIHtcbiAgICAgIC8vIGlmIG5vIGZpZWxkIHNlbGVjdGVkLFxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgZ2V0VGV4dDogbnVsbCxcbiAgICAgICAgY2hhcmFjdGVyU2V0OiBbXVxuICAgICAgfTtcbiAgICB9XG5cbiAgICBjb25zdCBnZXRUZXh0ID0gdGV4dExhYmVsQWNjZXNzb3IodGwpO1xuICAgIGxldCBjaGFyYWN0ZXJTZXQ7XG5cbiAgICBpZiAoXG4gICAgICAhdHJpZ2dlckNoYW5nZWRbYGdldExhYmVsQ2hhcmFjdGVyU2V0LSR7aX1gXSAmJlxuICAgICAgb2xkTGF5ZXJEYXRhICYmXG4gICAgICBvbGRMYXllckRhdGEudGV4dExhYmVscyAmJlxuICAgICAgb2xkTGF5ZXJEYXRhLnRleHRMYWJlbHNbaV1cbiAgICApIHtcbiAgICAgIGNoYXJhY3RlclNldCA9IG9sZExheWVyRGF0YS50ZXh0TGFiZWxzW2ldLmNoYXJhY3RlclNldDtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgYWxsTGFiZWxzID0gdGwuZmllbGQgPyBkYXRhLm1hcChnZXRUZXh0KSA6IFtdO1xuICAgICAgY2hhcmFjdGVyU2V0ID0gdW5pcShhbGxMYWJlbHMuam9pbignJykpO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBjaGFyYWN0ZXJTZXQsXG4gICAgICBnZXRUZXh0XG4gICAgfTtcbiAgfSk7XG59O1xuIl19