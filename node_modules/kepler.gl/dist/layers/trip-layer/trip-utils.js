"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.coordHasLength4 = coordHasLength4;
exports.containValidTime = containValidTime;
exports.isTripGeoJsonField = isTripGeoJsonField;
exports.parseTripGeoJsonTimestamp = parseTripGeoJsonTimestamp;
exports.getAnimationDomainFromTimestamps = getAnimationDomainFromTimestamps;

var _typeAnalyzer = require("type-analyzer");

var _dataUtils = require("../../utils/data-utils");

var _geojsonUtils = require("../geojson-layer/geojson-utils");

// Copyright (c) 2021 Uber Technologies, Inc.
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.

/**
 * Parse geojson from string
 * @param {array} samples feature object values
 * @returns {boolean} whether the geometry coordinates has length of 4
 */
function coordHasLength4(samples) {
  var hasLength4 = true;

  for (var i = 0; i < samples.length; i += 1) {
    hasLength4 = !samples[i].geometry.coordinates.find(function (c) {
      return c.length < 4;
    });

    if (!hasLength4) {
      break;
    }
  }

  return hasLength4;
}
/**
 * Check whether geojson linestring's 4th coordinate is 1) not timestamp 2) unix time stamp 3) real date time
 * @param {array} timestamps array to be tested if its elements are timestamp
 * @returns {object | boolean} the type of timestamp: unix/datetime/invalid(not timestamp)
 */


function containValidTime(timestamps) {
  var formattedTimeStamps = timestamps.map(function (ts) {
    return {
      ts: ts
    };
  });
  var ignoredDataTypes = Object.keys(_typeAnalyzer.DATA_TYPES).filter(function (type) {
    return ![_typeAnalyzer.DATA_TYPES.TIME, _typeAnalyzer.DATA_TYPES.DATETIME].includes(type);
  }); // ignore all types but TIME to improve performance

  var analyzedType = _typeAnalyzer.Analyzer.computeColMeta(formattedTimeStamps, [], {
    ignoredDataTypes: ignoredDataTypes
  })[0];

  if (!analyzedType || analyzedType.category !== 'TIME') {
    return false;
  }

  return analyzedType;
}
/**
 * Check if geojson features are trip layer animatable by meeting 3 conditions
 * @param {array} allData array of geojson feature objects
 * @param {object} field array of geojson feature objects
 * @returns {boolean} whether it is trip layer animatable
 */


function isTripGeoJsonField() {
  var allData = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];
  var field = arguments.length > 1 ? arguments[1] : undefined;

  if (!allData.length) {
    return false;
  }

  var getValue = function getValue(d) {
    return field.valueAccessor(d);
  };

  var maxCount = 10000;
  var sampleRawFeatures = allData.length > maxCount ? (0, _dataUtils.getSampleData)(allData, maxCount, getValue) : allData.map(getValue);
  var features = sampleRawFeatures.map(_geojsonUtils.parseGeoJsonRawFeature).filter(function (f) {
    return f;
  });
  var featureTypes = (0, _geojsonUtils.getGeojsonFeatureTypes)(features); // condition 1: contain line string

  if (!featureTypes.line) {
    return false;
  } // condition 2:sample line strings contain 4 coordinates


  if (!coordHasLength4(features)) {
    return false;
  } // condition 3:the 4th coordinate of the first feature line strings is valid time


  var tsHolder = features[0].geometry.coordinates.map(function (coord) {
    return coord[3];
  });
  return Boolean(containValidTime(tsHolder));
}
/**
 * Get unix timestamp from animatable geojson for deck.gl trip layer
 * @param {Array<Object>} dataToFeature array of geojson feature objects, can be null
 * @returns {{dataToTimeStamp: Array[Number], animationDomain: null | Array<Number>}} {dataToTimeStamp: [], animationDomain: null}
 */


function parseTripGeoJsonTimestamp(dataToFeature) {
  // Analyze type based on coordinates of the 1st lineString
  // select a sample trip to analyze time format
  var empty = {
    dataToTimeStamp: [],
    animationDomain: null
  };
  var sampleTrip = dataToFeature.find(function (f) {
    return f && f.geometry && f.geometry.coordinates && f.geometry.coordinates.length >= 3;
  }); // if no valid geometry

  if (!sampleTrip) {
    return empty;
  }

  var analyzedType = containValidTime(sampleTrip.geometry.coordinates.map(function (coord) {
    return coord[3];
  }));

  if (!analyzedType) {
    return empty;
  }

  var format = analyzedType.format;

  var getTimeValue = function getTimeValue(coord) {
    return coord && (0, _dataUtils.notNullorUndefined)(coord[3]) ? (0, _dataUtils.timeToUnixMilli)(coord[3], format) : null;
  };

  var dataToTimeStamp = dataToFeature.map(function (f) {
    return f && f.geometry && Array.isArray(f.geometry.coordinates) ? f.geometry.coordinates.map(getTimeValue) : null;
  });
  var animationDomain = getAnimationDomainFromTimestamps(dataToTimeStamp);
  return {
    dataToTimeStamp: dataToTimeStamp,
    animationDomain: animationDomain
  };
}

function findMinFromSorted() {
  var list = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];
  return list.find(function (d) {
    return (0, _dataUtils.notNullorUndefined)(d) && Number.isFinite(d);
  }) || null;
}

function findMaxFromSorted() {
  var list = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];
  var i = list.length - 1;

  while (i > 0) {
    if ((0, _dataUtils.notNullorUndefined)(list[i]) && Number.isFinite(list[i])) {
      return list[i];
    }

    i--;
  }

  return null;
}

function getAnimationDomainFromTimestamps() {
  var dataToTimeStamp = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];
  return dataToTimeStamp.reduce(function (accu, tss) {
    var tsMin = findMinFromSorted(tss);
    var tsMax = findMaxFromSorted(tss);

    if (Number.isFinite(tsMin) && Number.isFinite(tsMax)) {
      accu[0] = Math.min(accu[0], tsMin);
      accu[1] = Math.max(accu[1], tsMax);
    }

    return accu;
  }, [Infinity, -Infinity]);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9sYXllcnMvdHJpcC1sYXllci90cmlwLXV0aWxzLmpzIl0sIm5hbWVzIjpbImNvb3JkSGFzTGVuZ3RoNCIsInNhbXBsZXMiLCJoYXNMZW5ndGg0IiwiaSIsImxlbmd0aCIsImdlb21ldHJ5IiwiY29vcmRpbmF0ZXMiLCJmaW5kIiwiYyIsImNvbnRhaW5WYWxpZFRpbWUiLCJ0aW1lc3RhbXBzIiwiZm9ybWF0dGVkVGltZVN0YW1wcyIsIm1hcCIsInRzIiwiaWdub3JlZERhdGFUeXBlcyIsIk9iamVjdCIsImtleXMiLCJEQVRBX1RZUEVTIiwiZmlsdGVyIiwidHlwZSIsIlRJTUUiLCJEQVRFVElNRSIsImluY2x1ZGVzIiwiYW5hbHl6ZWRUeXBlIiwiQW5hbHl6ZXIiLCJjb21wdXRlQ29sTWV0YSIsImNhdGVnb3J5IiwiaXNUcmlwR2VvSnNvbkZpZWxkIiwiYWxsRGF0YSIsImZpZWxkIiwiZ2V0VmFsdWUiLCJkIiwidmFsdWVBY2Nlc3NvciIsIm1heENvdW50Iiwic2FtcGxlUmF3RmVhdHVyZXMiLCJmZWF0dXJlcyIsInBhcnNlR2VvSnNvblJhd0ZlYXR1cmUiLCJmIiwiZmVhdHVyZVR5cGVzIiwibGluZSIsInRzSG9sZGVyIiwiY29vcmQiLCJCb29sZWFuIiwicGFyc2VUcmlwR2VvSnNvblRpbWVzdGFtcCIsImRhdGFUb0ZlYXR1cmUiLCJlbXB0eSIsImRhdGFUb1RpbWVTdGFtcCIsImFuaW1hdGlvbkRvbWFpbiIsInNhbXBsZVRyaXAiLCJmb3JtYXQiLCJnZXRUaW1lVmFsdWUiLCJBcnJheSIsImlzQXJyYXkiLCJnZXRBbmltYXRpb25Eb21haW5Gcm9tVGltZXN0YW1wcyIsImZpbmRNaW5Gcm9tU29ydGVkIiwibGlzdCIsIk51bWJlciIsImlzRmluaXRlIiwiZmluZE1heEZyb21Tb3J0ZWQiLCJyZWR1Y2UiLCJhY2N1IiwidHNzIiwidHNNaW4iLCJ0c01heCIsIk1hdGgiLCJtaW4iLCJtYXgiLCJJbmZpbml0eSJdLCJtYXBwaW5ncyI6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YmVyIFRlY2hub2xvZ2llcywgSW5jLlxuLy9cbi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbi8vIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlIFwiU29mdHdhcmVcIiksIHRvIGRlYWxcbi8vIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHNcbi8vIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbi8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpc1xuLy8gZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczpcbi8vXG4vLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpblxuLy8gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG4vL1xuLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuLy8gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXG4vLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbi8vIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbi8vIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4vLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOXG4vLyBUSEUgU09GVFdBUkUuXG5cbmltcG9ydCB7QW5hbHl6ZXIsIERBVEFfVFlQRVN9IGZyb20gJ3R5cGUtYW5hbHl6ZXInO1xuXG5pbXBvcnQge2dldFNhbXBsZURhdGEsIHRpbWVUb1VuaXhNaWxsaSwgbm90TnVsbG9yVW5kZWZpbmVkfSBmcm9tICd1dGlscy9kYXRhLXV0aWxzJztcblxuaW1wb3J0IHtwYXJzZUdlb0pzb25SYXdGZWF0dXJlLCBnZXRHZW9qc29uRmVhdHVyZVR5cGVzfSBmcm9tICdsYXllcnMvZ2VvanNvbi1sYXllci9nZW9qc29uLXV0aWxzJztcblxuLyoqXG4gKiBQYXJzZSBnZW9qc29uIGZyb20gc3RyaW5nXG4gKiBAcGFyYW0ge2FycmF5fSBzYW1wbGVzIGZlYXR1cmUgb2JqZWN0IHZhbHVlc1xuICogQHJldHVybnMge2Jvb2xlYW59IHdoZXRoZXIgdGhlIGdlb21ldHJ5IGNvb3JkaW5hdGVzIGhhcyBsZW5ndGggb2YgNFxuICovXG5leHBvcnQgZnVuY3Rpb24gY29vcmRIYXNMZW5ndGg0KHNhbXBsZXMpIHtcbiAgbGV0IGhhc0xlbmd0aDQgPSB0cnVlO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IHNhbXBsZXMubGVuZ3RoOyBpICs9IDEpIHtcbiAgICBoYXNMZW5ndGg0ID0gIXNhbXBsZXNbaV0uZ2VvbWV0cnkuY29vcmRpbmF0ZXMuZmluZChjID0+IGMubGVuZ3RoIDwgNCk7XG4gICAgaWYgKCFoYXNMZW5ndGg0KSB7XG4gICAgICBicmVhaztcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGhhc0xlbmd0aDQ7XG59XG5cbi8qKlxuICogQ2hlY2sgd2hldGhlciBnZW9qc29uIGxpbmVzdHJpbmcncyA0dGggY29vcmRpbmF0ZSBpcyAxKSBub3QgdGltZXN0YW1wIDIpIHVuaXggdGltZSBzdGFtcCAzKSByZWFsIGRhdGUgdGltZVxuICogQHBhcmFtIHthcnJheX0gdGltZXN0YW1wcyBhcnJheSB0byBiZSB0ZXN0ZWQgaWYgaXRzIGVsZW1lbnRzIGFyZSB0aW1lc3RhbXBcbiAqIEByZXR1cm5zIHtvYmplY3QgfCBib29sZWFufSB0aGUgdHlwZSBvZiB0aW1lc3RhbXA6IHVuaXgvZGF0ZXRpbWUvaW52YWxpZChub3QgdGltZXN0YW1wKVxuICovXG5cbmV4cG9ydCBmdW5jdGlvbiBjb250YWluVmFsaWRUaW1lKHRpbWVzdGFtcHMpIHtcbiAgY29uc3QgZm9ybWF0dGVkVGltZVN0YW1wcyA9IHRpbWVzdGFtcHMubWFwKHRzID0+ICh7dHN9KSk7XG4gIGNvbnN0IGlnbm9yZWREYXRhVHlwZXMgPSBPYmplY3Qua2V5cyhEQVRBX1RZUEVTKS5maWx0ZXIoXG4gICAgdHlwZSA9PiAhW0RBVEFfVFlQRVMuVElNRSwgREFUQV9UWVBFUy5EQVRFVElNRV0uaW5jbHVkZXModHlwZSlcbiAgKTtcblxuICAvLyBpZ25vcmUgYWxsIHR5cGVzIGJ1dCBUSU1FIHRvIGltcHJvdmUgcGVyZm9ybWFuY2VcbiAgY29uc3QgYW5hbHl6ZWRUeXBlID0gQW5hbHl6ZXIuY29tcHV0ZUNvbE1ldGEoZm9ybWF0dGVkVGltZVN0YW1wcywgW10sIHtpZ25vcmVkRGF0YVR5cGVzfSlbMF07XG5cbiAgaWYgKCFhbmFseXplZFR5cGUgfHwgYW5hbHl6ZWRUeXBlLmNhdGVnb3J5ICE9PSAnVElNRScpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbiAgcmV0dXJuIGFuYWx5emVkVHlwZTtcbn1cblxuLyoqXG4gKiBDaGVjayBpZiBnZW9qc29uIGZlYXR1cmVzIGFyZSB0cmlwIGxheWVyIGFuaW1hdGFibGUgYnkgbWVldGluZyAzIGNvbmRpdGlvbnNcbiAqIEBwYXJhbSB7YXJyYXl9IGFsbERhdGEgYXJyYXkgb2YgZ2VvanNvbiBmZWF0dXJlIG9iamVjdHNcbiAqIEBwYXJhbSB7b2JqZWN0fSBmaWVsZCBhcnJheSBvZiBnZW9qc29uIGZlYXR1cmUgb2JqZWN0c1xuICogQHJldHVybnMge2Jvb2xlYW59IHdoZXRoZXIgaXQgaXMgdHJpcCBsYXllciBhbmltYXRhYmxlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpc1RyaXBHZW9Kc29uRmllbGQoYWxsRGF0YSA9IFtdLCBmaWVsZCkge1xuICBpZiAoIWFsbERhdGEubGVuZ3RoKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG4gIGNvbnN0IGdldFZhbHVlID0gZCA9PiBmaWVsZC52YWx1ZUFjY2Vzc29yKGQpO1xuICBjb25zdCBtYXhDb3VudCA9IDEwMDAwO1xuICBjb25zdCBzYW1wbGVSYXdGZWF0dXJlcyA9XG4gICAgYWxsRGF0YS5sZW5ndGggPiBtYXhDb3VudCA/IGdldFNhbXBsZURhdGEoYWxsRGF0YSwgbWF4Q291bnQsIGdldFZhbHVlKSA6IGFsbERhdGEubWFwKGdldFZhbHVlKTtcblxuICBjb25zdCBmZWF0dXJlcyA9IHNhbXBsZVJhd0ZlYXR1cmVzLm1hcChwYXJzZUdlb0pzb25SYXdGZWF0dXJlKS5maWx0ZXIoZiA9PiBmKTtcbiAgY29uc3QgZmVhdHVyZVR5cGVzID0gZ2V0R2VvanNvbkZlYXR1cmVUeXBlcyhmZWF0dXJlcyk7XG5cbiAgLy8gY29uZGl0aW9uIDE6IGNvbnRhaW4gbGluZSBzdHJpbmdcbiAgaWYgKCFmZWF0dXJlVHlwZXMubGluZSkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIC8vIGNvbmRpdGlvbiAyOnNhbXBsZSBsaW5lIHN0cmluZ3MgY29udGFpbiA0IGNvb3JkaW5hdGVzXG4gIGlmICghY29vcmRIYXNMZW5ndGg0KGZlYXR1cmVzKSkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIC8vIGNvbmRpdGlvbiAzOnRoZSA0dGggY29vcmRpbmF0ZSBvZiB0aGUgZmlyc3QgZmVhdHVyZSBsaW5lIHN0cmluZ3MgaXMgdmFsaWQgdGltZVxuICBjb25zdCB0c0hvbGRlciA9IGZlYXR1cmVzWzBdLmdlb21ldHJ5LmNvb3JkaW5hdGVzLm1hcChjb29yZCA9PiBjb29yZFszXSk7XG5cbiAgcmV0dXJuIEJvb2xlYW4oY29udGFpblZhbGlkVGltZSh0c0hvbGRlcikpO1xufVxuXG4vKipcbiAqIEdldCB1bml4IHRpbWVzdGFtcCBmcm9tIGFuaW1hdGFibGUgZ2VvanNvbiBmb3IgZGVjay5nbCB0cmlwIGxheWVyXG4gKiBAcGFyYW0ge0FycmF5PE9iamVjdD59IGRhdGFUb0ZlYXR1cmUgYXJyYXkgb2YgZ2VvanNvbiBmZWF0dXJlIG9iamVjdHMsIGNhbiBiZSBudWxsXG4gKiBAcmV0dXJucyB7e2RhdGFUb1RpbWVTdGFtcDogQXJyYXlbTnVtYmVyXSwgYW5pbWF0aW9uRG9tYWluOiBudWxsIHwgQXJyYXk8TnVtYmVyPn19IHtkYXRhVG9UaW1lU3RhbXA6IFtdLCBhbmltYXRpb25Eb21haW46IG51bGx9XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBwYXJzZVRyaXBHZW9Kc29uVGltZXN0YW1wKGRhdGFUb0ZlYXR1cmUpIHtcbiAgLy8gQW5hbHl6ZSB0eXBlIGJhc2VkIG9uIGNvb3JkaW5hdGVzIG9mIHRoZSAxc3QgbGluZVN0cmluZ1xuICAvLyBzZWxlY3QgYSBzYW1wbGUgdHJpcCB0byBhbmFseXplIHRpbWUgZm9ybWF0XG4gIGNvbnN0IGVtcHR5ID0ge2RhdGFUb1RpbWVTdGFtcDogW10sIGFuaW1hdGlvbkRvbWFpbjogbnVsbH07XG4gIGNvbnN0IHNhbXBsZVRyaXAgPSBkYXRhVG9GZWF0dXJlLmZpbmQoXG4gICAgZiA9PiBmICYmIGYuZ2VvbWV0cnkgJiYgZi5nZW9tZXRyeS5jb29yZGluYXRlcyAmJiBmLmdlb21ldHJ5LmNvb3JkaW5hdGVzLmxlbmd0aCA+PSAzXG4gICk7XG5cbiAgLy8gaWYgbm8gdmFsaWQgZ2VvbWV0cnlcbiAgaWYgKCFzYW1wbGVUcmlwKSB7XG4gICAgcmV0dXJuIGVtcHR5O1xuICB9XG5cbiAgY29uc3QgYW5hbHl6ZWRUeXBlID0gY29udGFpblZhbGlkVGltZShzYW1wbGVUcmlwLmdlb21ldHJ5LmNvb3JkaW5hdGVzLm1hcChjb29yZCA9PiBjb29yZFszXSkpO1xuXG4gIGlmICghYW5hbHl6ZWRUeXBlKSB7XG4gICAgcmV0dXJuIGVtcHR5O1xuICB9XG5cbiAgY29uc3Qge2Zvcm1hdH0gPSBhbmFseXplZFR5cGU7XG4gIGNvbnN0IGdldFRpbWVWYWx1ZSA9IGNvb3JkID0+XG4gICAgY29vcmQgJiYgbm90TnVsbG9yVW5kZWZpbmVkKGNvb3JkWzNdKSA/IHRpbWVUb1VuaXhNaWxsaShjb29yZFszXSwgZm9ybWF0KSA6IG51bGw7XG5cbiAgY29uc3QgZGF0YVRvVGltZVN0YW1wID0gZGF0YVRvRmVhdHVyZS5tYXAoZiA9PlxuICAgIGYgJiYgZi5nZW9tZXRyeSAmJiBBcnJheS5pc0FycmF5KGYuZ2VvbWV0cnkuY29vcmRpbmF0ZXMpXG4gICAgICA/IGYuZ2VvbWV0cnkuY29vcmRpbmF0ZXMubWFwKGdldFRpbWVWYWx1ZSlcbiAgICAgIDogbnVsbFxuICApO1xuXG4gIGNvbnN0IGFuaW1hdGlvbkRvbWFpbiA9IGdldEFuaW1hdGlvbkRvbWFpbkZyb21UaW1lc3RhbXBzKGRhdGFUb1RpbWVTdGFtcCk7XG5cbiAgcmV0dXJuIHtkYXRhVG9UaW1lU3RhbXAsIGFuaW1hdGlvbkRvbWFpbn07XG59XG5cbmZ1bmN0aW9uIGZpbmRNaW5Gcm9tU29ydGVkKGxpc3QgPSBbXSkge1xuICByZXR1cm4gbGlzdC5maW5kKGQgPT4gbm90TnVsbG9yVW5kZWZpbmVkKGQpICYmIE51bWJlci5pc0Zpbml0ZShkKSkgfHwgbnVsbDtcbn1cblxuZnVuY3Rpb24gZmluZE1heEZyb21Tb3J0ZWQobGlzdCA9IFtdKSB7XG4gIGxldCBpID0gbGlzdC5sZW5ndGggLSAxO1xuICB3aGlsZSAoaSA+IDApIHtcbiAgICBpZiAobm90TnVsbG9yVW5kZWZpbmVkKGxpc3RbaV0pICYmIE51bWJlci5pc0Zpbml0ZShsaXN0W2ldKSkge1xuICAgICAgcmV0dXJuIGxpc3RbaV07XG4gICAgfVxuICAgIGktLTtcbiAgfVxuICByZXR1cm4gbnVsbDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldEFuaW1hdGlvbkRvbWFpbkZyb21UaW1lc3RhbXBzKGRhdGFUb1RpbWVTdGFtcCA9IFtdKSB7XG4gIHJldHVybiBkYXRhVG9UaW1lU3RhbXAucmVkdWNlKFxuICAgIChhY2N1LCB0c3MpID0+IHtcbiAgICAgIGNvbnN0IHRzTWluID0gZmluZE1pbkZyb21Tb3J0ZWQodHNzKTtcbiAgICAgIGNvbnN0IHRzTWF4ID0gZmluZE1heEZyb21Tb3J0ZWQodHNzKTtcbiAgICAgIGlmIChOdW1iZXIuaXNGaW5pdGUodHNNaW4pICYmIE51bWJlci5pc0Zpbml0ZSh0c01heCkpIHtcbiAgICAgICAgYWNjdVswXSA9IE1hdGgubWluKGFjY3VbMF0sIHRzTWluKTtcbiAgICAgICAgYWNjdVsxXSA9IE1hdGgubWF4KGFjY3VbMV0sIHRzTWF4KTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBhY2N1O1xuICAgIH0sXG4gICAgW0luZmluaXR5LCAtSW5maW5pdHldXG4gICk7XG59XG4iXX0=